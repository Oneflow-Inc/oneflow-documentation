
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="OneFlow -- 极致性能的分布式机器学习框架">
      
      
      
      
        <link rel="canonical" href="https://docs.oneflow.org/v0.4.0/adv_examples/resnet.html">
      
      <link rel="icon" href="../assets/favicon.png">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-7.1.11">
    
    
      
        <title>ResNet - OneFlow</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.3754935a.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.f1a3b89f.min.css">
        
          
          
          <meta name="theme-color" content="#4051b5">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#introduction" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../index.html" title="OneFlow" class="md-header__button md-logo" aria-label="OneFlow" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 89 89">
  <path d="M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z" />
  <path d="M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z" style="fill-opacity: 0.5" />
  <path d="M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z" />
  <path d="M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z" style="fill-opacity: 0.25" />
</svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            OneFlow
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ResNet
            
          </span>
        </div>
      </div>
    </div>
    
    
      <div class="md-header__option">
        <div class="md-select">
          
          <button class="md-header__button md-icon" aria-label="Select language">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.52 17.52 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04M18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12m-2.62 7 1.62-4.33L19.12 17h-3.24z"/></svg>
          </button>
          <div class="md-select__inner">
            <ul class="md-select__list">
              
                <li class="md-select__item">
                  <a href="https://docs.oneflow.org/en/v0.4.0/" hreflang="en" class="md-select__link">
                    English
                  </a>
                </li>
                
                <li class="md-select__item">
                  <a href="https://docs.oneflow.org/v0.4.0/" hreflang="zh" class="md-select__link">
                    中文
                  </a>
                </li>
                
            </ul>
          </div>
        </div>
      </div>
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://www.github.com/oneflow-Inc/oneflow" title="前往 GitHub 仓库" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    OneFlow
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../index.html" class="md-tabs__link">
      首页
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../quick_start/install.html" class="md-tabs__link">
        快速上手
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../basics_topics/data_input.html" class="md-tabs__link">
        基础专题
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../extended_topics/job_function_define_call.html" class="md-tabs__link">
        扩展专题
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="resnet.html" class="md-tabs__link md-tabs__link--active">
        高级应用实例
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="https://oneflow.readthedocs.io/en/master/" class="md-tabs__link">
        API
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../contribute/intro.html" class="md-tabs__link">
        OneFlow 开源计划
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="OneFlow" class="md-nav__button md-logo" aria-label="OneFlow" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 89 89">
  <path d="M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z" />
  <path d="M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z" style="fill-opacity: 0.5" />
  <path d="M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z" />
  <path d="M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z" style="fill-opacity: 0.25" />
</svg>

    </a>
    OneFlow
  </label>
  
    <div class="md-nav__source">
      
<a href="https://www.github.com/oneflow-Inc/oneflow" title="前往 GitHub 仓库" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    OneFlow
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        首页
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      <label class="md-nav__link" for="__nav_2">
        快速上手
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="快速上手" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          快速上手
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../quick_start/install.html" class="md-nav__link">
        安装
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../quick_start/quickstart_in_3_min.html" class="md-nav__link">
        3分钟快速上手
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../quick_start/lenet_mnist.html" class="md-nav__link">
        识别 MNIST 手写体数字
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      <label class="md-nav__link" for="__nav_3">
        基础专题
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="基础专题" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          基础专题
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../basics_topics/data_input.html" class="md-nav__link">
        数据输入
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../basics_topics/build_nn_with_op_and_layer.html" class="md-nav__link">
        搭建神经网络
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../basics_topics/optimizer_in_function_config.html" class="md-nav__link">
        优化算法及超参配置
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../basics_topics/async_get.html" class="md-nav__link">
        获取作业函数的结果
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../basics_topics/model_load_save.html" class="md-nav__link">
        模型的加载与保存
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../basics_topics/distributed_train.html" class="md-nav__link">
        分布式训练
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../basics_topics/concept_explanation.html" class="md-nav__link">
        OneFlow 概念清单
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../basics_topics/essentials_of_oneflow.html" class="md-nav__link">
        OneFlow 系统设计
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      <label class="md-nav__link" for="__nav_4">
        扩展专题
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="扩展专题" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          扩展专题
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../extended_topics/job_function_define_call.html" class="md-nav__link">
        作业函数的定义与调用
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../extended_topics/consistent_mirrored.html" class="md-nav__link">
        Consistent 与 Mirrored 视角
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../extended_topics/model_mixed_parallel.html" class="md-nav__link">
        OneFlow 的并行特色
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../extended_topics/ofrecord.html" class="md-nav__link">
        OFRecord 数据格式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../extended_topics/how_to_make_ofdataset.html" class="md-nav__link">
        加载与准备 OFRecord 数据集
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../extended_topics/how_to_convert_image_to_ofrecord.html" class="md-nav__link">
        将图片文件制作为 OFRecord 数据集
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../extended_topics/watch_watch_diff.html" class="md-nav__link">
        获取运行时数据
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../extended_topics/debug_by_vscode.html" class="md-nav__link">
        使用 VS Code 调试 OneFlow
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../extended_topics/python_kernel_op.html" class="md-nav__link">
        使用 Python 扩展 Op
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../extended_topics/user_op.html" class="md-nav__link">
        使用 C++ 扩展 Op
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../extended_topics/implement_data_loader.html" class="md-nav__link">
        自定义 DataLoader
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../extended_topics/oneflow_convert_tools.html" class="md-nav__link">
        OneFlow 和 ONNX 交互
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" checked>
      
      <label class="md-nav__link" for="__nav_5">
        高级应用实例
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="高级应用实例" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          高级应用实例
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          ResNet
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="resnet.html" class="md-nav__link md-nav__link--active">
        ResNet
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    简介 Introduction
  </a>
  
    <nav class="md-nav" aria-label="简介 Introduction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cnn" class="md-nav__link">
    图像分类与CNN
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#resnet" class="md-nav__link">
    ResNet
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#requirements" class="md-nav__link">
    准备工作 Requirements
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#quick-start" class="md-nav__link">
    快速开始 Quick Start
  </a>
  
    <nav class="md-nav" aria-label="快速开始 Quick Start">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    预训练模型
  </a>
  
    <nav class="md-nav" aria-label="预训练模型">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#resnet50" class="md-nav__link">
    resnet50
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    预测/推理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#train-validation" class="md-nav__link">
    训练和验证（Train &amp; Validation）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluate" class="md-nav__link">
    评估(Evaluate)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#details" class="md-nav__link">
    更详细的说明 Details
  </a>
  
    <nav class="md-nav" aria-label="更详细的说明 Details">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    分布式训练
  </a>
  
    <nav class="md-nav" aria-label="分布式训练">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    如何配置并运行分布式训练？
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    混合精度训练与预测
  </a>
  
    <nav class="md-nav" aria-label="混合精度训练与预测">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#float16-float32" class="md-nav__link">
    如何开启 float16 / float32 混合精度训练？
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    混合精度模型
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced" class="md-nav__link">
    进阶 Advanced
  </a>
  
    <nav class="md-nav" aria-label="进阶 Advanced">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    参数对齐
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    数据集制作
  </a>
  
    <nav class="md-nav" aria-label="数据集制作">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    用于图像分类数据集简介
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#oneflow-onnx" class="md-nav__link">
    OneFlow 模型转 ONNX 模型
  </a>
  
    <nav class="md-nav" aria-label="OneFlow 模型转 ONNX 模型">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    简介
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    快速上手
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#onnx" class="md-nav__link">
    如何生成 ONNX 模型
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#onnx_1" class="md-nav__link">
    验证 ONNX 模型的正确性
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="yolov3.html" class="md-nav__link">
        YoloV3
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="bert.html" class="md-nav__link">
        BERT
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="wide_deep.html" class="md-nav__link">
        Wide & Deep
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      <label class="md-nav__link" for="__nav_6">
        API
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="API" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          API
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="https://oneflow.readthedocs.io/en/master/" class="md-nav__link">
        API
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      <label class="md-nav__link" for="__nav_7">
        OneFlow 开源计划
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="OneFlow 开源计划" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          OneFlow 开源计划
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../contribute/intro.html" class="md-nav__link">
        OneFlow 开源计划
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    简介 Introduction
  </a>
  
    <nav class="md-nav" aria-label="简介 Introduction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cnn" class="md-nav__link">
    图像分类与CNN
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#resnet" class="md-nav__link">
    ResNet
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#requirements" class="md-nav__link">
    准备工作 Requirements
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#quick-start" class="md-nav__link">
    快速开始 Quick Start
  </a>
  
    <nav class="md-nav" aria-label="快速开始 Quick Start">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    预训练模型
  </a>
  
    <nav class="md-nav" aria-label="预训练模型">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#resnet50" class="md-nav__link">
    resnet50
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    预测/推理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#train-validation" class="md-nav__link">
    训练和验证（Train &amp; Validation）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluate" class="md-nav__link">
    评估(Evaluate)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#details" class="md-nav__link">
    更详细的说明 Details
  </a>
  
    <nav class="md-nav" aria-label="更详细的说明 Details">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    分布式训练
  </a>
  
    <nav class="md-nav" aria-label="分布式训练">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    如何配置并运行分布式训练？
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    混合精度训练与预测
  </a>
  
    <nav class="md-nav" aria-label="混合精度训练与预测">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#float16-float32" class="md-nav__link">
    如何开启 float16 / float32 混合精度训练？
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    混合精度模型
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced" class="md-nav__link">
    进阶 Advanced
  </a>
  
    <nav class="md-nav" aria-label="进阶 Advanced">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    参数对齐
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    数据集制作
  </a>
  
    <nav class="md-nav" aria-label="数据集制作">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    用于图像分类数据集简介
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#oneflow-onnx" class="md-nav__link">
    OneFlow 模型转 ONNX 模型
  </a>
  
    <nav class="md-nav" aria-label="OneFlow 模型转 ONNX 模型">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    简介
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    快速上手
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#onnx" class="md-nav__link">
    如何生成 ONNX 模型
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#onnx_1" class="md-nav__link">
    验证 ONNX 模型的正确性
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/OneFlow-Inc/oneflow-documentation/blob/master/cn/docs/adv_examples/resnet.md" title="编辑此页" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  <h1>ResNet</h1>
                
                <h2 id="introduction">简介 Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h2>
<h3 id="cnn">图像分类与CNN<a class="headerlink" href="#cnn" title="Permanent link">&para;</a></h3>
<p><strong>图像分类</strong> 是指将图像信息中所反映的不同特征，把不同类别的目标区分开来的图像处理方法，是计算机视觉中其他任务，比如目标检测、语义分割、人脸识别等高层视觉任务的基础。</p>
<p>ImageNet 大规模视觉识别挑战赛（ILSVRC），常称为 ImageNet 竞赛，包括图像分类、物体定位，以及物体检测等任务，是推动计算机视觉领域发展最重要的比赛之一。</p>
<p>在2012年的 ImageNet 竞赛中，深度卷积网络 AlexNet 横空出世。以超出第二名10%以上的top-5准确率，勇夺 ImageNet2012 比赛的冠军。从此，以 <strong>CNN（卷积神经网络）</strong> 为代表的深度学习方法开始在计算机视觉领域的应用开始大放异彩，更多的更深的CNN网络被提出，比如 ImageNet2014 比赛的冠军 VGGNet, ImageNet2015 比赛的冠军 ResNet。</p>
<h3 id="resnet">ResNet<a class="headerlink" href="#resnet" title="Permanent link">&para;</a></h3>
<p><a href="https://arxiv.org/abs/1512.03385">ResNet</a> 是2015年ImageNet竞赛的冠军。目前，ResNet 相对对于传统的机器学习分类算法而言，效果已经相当的出色，之后大量的检测，分割，识别等任务也都在 ResNet 基础上完成。</p>
<p><a href="https://github.com/Oneflow-Inc/OneFlow-Benchmark">OneFlow-Benchmark</a> 仓库中，提供 ResNet50 v1.5 的 OneFlow 实现。我们在 ImageNet-2012 数据集上训练90轮后，验证集上的准确率能够达到：77.318%(top1)，93.622%(top5)。</p>
<p>更详细的网络参数对齐工作，见 <a href="https://github.com/Oneflow-Inc/OneFlow-Benchmark/blob/master/Classification/cnns">OneFlow-Benchmark的cnns</a> 部分</p>
<p><img alt="resnet50_validation_acuracy" src="imgs/resnet50_validation_acuracy.png" /></p>
<p><strong>关于 ResNet50 v1.5 的说明：</strong></p>
<blockquote>
<p>ResNet50 v1.5 是原始 <a href="https://arxiv.org/abs/1512.03385">ResNet50 v1</a> 的一个改进版本，相对于原始的模型，精度稍有提升 (~0.5% top1)，详细说明参见<a href="https://github.com/NVIDIA/DeepLearningExamples/tree/master/MxNet/Classification/RN50v1.5">这里</a> 。
</p>
</blockquote>
<p>准备好亲自动手，复现上面的结果了吗？</p>
<p>下面，本文就以上面的 ResNet50 为例，一步步展现如何使用 OneFlow 进行 ResNet50 网络的训练和预测。</p>
<p>主要内容包括：</p>
<ul>
<li>准备工作</li>
<li>
<p>项目安装和准备工作</p>
</li>
<li>
<p>快速开始</p>
</li>
<li>预测/推理</li>
<li>训练和验证</li>
<li>评估</li>
<li>更详细的说明</li>
<li>分布式训练</li>
<li>混合精度训练与预测</li>
<li>进阶</li>
<li>参数对齐</li>
<li>数据集制作(ImageNet2012)</li>
<li>OneFlow 模型转 ONNX 模型</li>
</ul>
<h2 id="requirements">准备工作 Requirements<a class="headerlink" href="#requirements" title="Permanent link">&para;</a></h2>
<p>别担心，使用 OneFlow 非常容易，只要准备好下面三步，即可开始 OneFlow 的图像识别之旅。</p>
<ul>
<li>
<p>安装 OneFlow，安装方式参考 <a href="https://github.com/Oneflow-Inc/oneflow">OneFlow项目主页</a></p>
</li>
<li>
<p>克隆/下载 <a href="https://github.com/Oneflow-Inc/OneFlow-Benchmark">OneFlow-Benchmark</a> 仓库。</p>
</li>
</ul>
<p><code>git clone git@github.com:Oneflow-Inc/OneFlow-Benchmark.git</code></p>
<p><code>cd  OneFlow-Benchmark/Classification/cnns</code></p>
<ul>
<li>
<p>准备数据集（可选）</p>
</li>
<li>
<p>直接使用 synthetic 虚拟合成数据集</p>
</li>
<li>下载我们制作的 Imagenet(2012) <a href="https://oneflow-public.oss-cn-beijing.aliyuncs.com/online_document/dataset/imagenet/mini-imagenet.zip">迷你数据集</a> 解压放入data目录</li>
<li>或者：制作完整 OFRecord 格式的 ImageNet 数据集（见下文进阶部分）</li>
</ul>
<p>我们提供了通用脚本：<code>train.sh</code> 和 <code>inference.sh</code>，它们适用于此仓库下所有cnn网络模型的训练、验证、推理。您可以通过设置参数使用不同的模型、数据集来训练/推理。</p>
<p><strong>关于模型的说明：</strong></p>
<blockquote>
<p>默认情况下，我们使用resnet50，您也可以通过改动脚本中的--model参数指定其他模型，如：<code>--model="resnet50"</code>，<code>--model="vgg"</code> 等。</p>
</blockquote>
<p><strong>关于数据集的说明：</strong></p>
<blockquote>
<p>1）为了使读者快速上手，我们提供了 synthetic 虚拟合成数据，“合成数据”是指不通过磁盘加载数据，而是直接在内存中生成一些随机数据，作为神经网络的数据输入源。</p>
<p>2）同时，我们提供了一个小的迷你示例数据集。直接下载解压至 cnn 项目的 data 目录，即可快速开始训练。读者可以在熟悉了流程后，参考数据集制作部分，制作完整的 Imagenet2012 数据集。</p>
<p>3）使用 OFRcord 格式的数据集可以提高数据加载效率（但这非必须，参考<a href="../basics_topics/data_input.html">数据输入</a>，OneFlow 支持直接加载 numpy 数据）。</p>
</blockquote>
<h2 id="quick-start">快速开始 Quick Start<a class="headerlink" href="#quick-start" title="Permanent link">&para;</a></h2>
<p>那么接下来，立马开始 OneFlow 的图像识别之旅吧！</p>
<p>首先，切换到目录：</p>
<div class="highlight"><pre><span></span><code>cd OneFlow-Benchmark/Classification/cnns
</code></pre></div>
<h3 id="_1">预训练模型<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h3>
<h4 id="resnet50">resnet50<a class="headerlink" href="#resnet50" title="Permanent link">&para;</a></h4>
<p><a href="https://oneflow-public.oss-cn-beijing.aliyuncs.com/model_zoo/resnet_v15_of_best_model_val_top1_77318.tgz">resnet50_v1.5_model</a> (validation accuracy: 77.318% top1，93.622% top5 )</p>
<h3 id="_2">预测/推理<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>下载好预训练模型后，解压后放入当前目录，然后执行：</p>
<div class="highlight"><pre><span></span><code>sh inference.sh
</code></pre></div>
<p>此脚本将调用模型对这张金鱼图片进行分类：</p>
<div align="center">
    <img src="imgs/fish.jpg" align='center'/>
</div>

<p>若输出下面的内容，则表示预测成功：</p>
<div class="highlight"><pre><span></span><code>data/fish.jpg
0.87059885 goldfish, Carassius auratus
</code></pre></div>
<p>可见，模型判断这张图片有87.05%的概率是金鱼 goldfish。</p>
<h3 id="train-validation">训练和验证（Train &amp; Validation）<a class="headerlink" href="#train-validation" title="Permanent link">&para;</a></h3>
<ul>
<li>训练同样很简单，只需执行：</li>
</ul>
<div class="highlight"><pre><span></span><code>sh train.sh
</code></pre></div>
<p>即可开始模型的训练，您将看到如下输出：</p>
<div class="highlight"><pre><span></span><code>Loading synthetic data.
Loading synthetic data.
Saving model to ./output/snapshots/model_save-20200723124215/snapshot_initial_model.
Init model on demand.
train: epoch 0, iter 10, loss: 7.197278, top_1: 0.000000, top_k: 0.000000, samples/s: 61.569
train: epoch 0, iter 20, loss: 6.177684, top_1: 0.000000, top_k: 0.000000, samples/s: 122.555
Saving model to ./output/snapshots/model_save-20200723124215/snapshot_epoch_0.
train: epoch 0, iter 30, loss: 3.988656, top_1: 0.525000, top_k: 0.812500, samples/s: 120.337
train: epoch 1, iter 10, loss: 1.185733, top_1: 1.000000, top_k: 1.000000, samples/s: 80.705
train: epoch 1, iter 20, loss: 1.042017, top_1: 1.000000, top_k: 1.000000, samples/s: 118.478
Saving model to ./output/snapshots/model_save-20200723124215/snapshot_epoch_1.
...
</code></pre></div>
<blockquote>
<p>为了方便运行演示，我们默认使用synthetic虚拟合成数据集，使您可以快速看到模型运行的效果</p>
</blockquote>
<p>同样，你也可以使用<a href="https://oneflow-public.oss-cn-beijing.aliyuncs.com/online_document/dataset/imagenet/mini-imagenet.zip">迷你示例数据集</a>，下载解压后放入 cnn 项目的 data 目录即可，然后修改训练脚本如下：</p>
<div class="highlight"><pre><span></span><code>rm -rf core.*
rm -rf ./output/snapshots/*

DATA_ROOT=data/imagenet/ofrecord

python3 of_cnn_train_val.py \
    --train_data_dir=$DATA_ROOT/train \
    --num_examples=50 \
    --train_data_part_num=1 \
    --val_data_dir=$DATA_ROOT/validation \
    --num_val_examples=50 \
    --val_data_part_num=1 \
    --num_nodes=1 \
    --gpu_num_per_node=1 \
    --model_update=&quot;momentum&quot; \
    --learning_rate=0.001 \
    --loss_print_every_n_iter=1 \
    --batch_size_per_device=16 \
    --val_batch_size_per_device=10 \
    --num_epoch=10 \
    --model=&quot;resnet50&quot;
</code></pre></div>
<p>运行此脚本，将在仅有50张金鱼图片的迷你 ImageNet 数据集上，训练出一个分类模型，利用它，你可以对金鱼图片进行分类。</p>
<p>不要着急，如果您需要在完整的 ImageNet2012 数据集上进行训练，请参考：<a href="https://github.com/Oneflow-Inc/OneFlow-Benchmark/blob/master/Classification/cnns">OneFlow-Benchmark</a>仓库。</p>
<h3 id="evaluate">评估(Evaluate)<a class="headerlink" href="#evaluate" title="Permanent link">&para;</a></h3>
<p>你可以使用自己训练好的模型，或者我们提供的 <a href="https://oneflow-public.oss-cn-beijing.aliyuncs.com/model_zoo/resnet_v15_of_best_model_val_top1_77318.tgz">resnet50_v1.5_model</a> （解压后放入当前目录），对resnet50模型的精度进行评估。</p>
<p>只需运行：</p>
<div class="highlight"><pre><span></span><code>sh evaluate.sh
</code></pre></div>
<p>即可获得训练好的模型在50000张验证集上的准确率：</p>
<div class="highlight"><pre><span></span><code>Time stamp: 2020-07-27-09:28:28
Restoring model from resnet_v15_of_best_model_val_top1_77318.
I0727 09:28:28.773988162    8411 ev_epoll_linux.c:82]        Use of signals is disabled. Epoll engine will not be used
Loading data from /dataset/ImageNet/ofrecord/validation
validation: epoch 0, iter 195, top_1: 0.773277, top_k: 0.936058, samples/s: 1578.325
validation: epoch 0, iter 195, top_1: 0.773237, top_k: 0.936078, samples/s: 1692.303
validation: epoch 0, iter 195, top_1: 0.773297, top_k: 0.936018, samples/s: 1686.896
</code></pre></div>
<blockquote>
<p>执行 <code>sh evaluate.sh</code> 前，确保准备了 ImageNet(2012) 的验证集，验证集制作方法请参考：<a href="https://github.com/Oneflow-Inc/OneFlow-Benchmark/blob/master/Classification/cnns">OneFlow-Benchmark</a>仓库。</p>
</blockquote>
<p>从3轮的评估结果来看，我们的模型在 ImageNet(2012) 上已经达到了77.32+%的 top1 精度。</p>
<p>最后，恭喜你！完成了 Resnet 模型在 ImageNet 上完整的训练/验证、推理和评估，为自己鼓个掌吧！</p>
<h2 id="details">更详细的说明 Details<a class="headerlink" href="#details" title="Permanent link">&para;</a></h2>
<h3 id="_3">分布式训练<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p><strong>简单而易用的分布式，是 OneFlow 的主打特色之一。</strong></p>
<p>OneFlow 框架从底层设计上，就原生支持高效的分布式训练。尤其对于分布式的数据并行，用户完全不用操心算法从单机单卡扩展到多机多卡时，数据如何划分以及同步的问题。也就是说，使用 OneFlow，用户以单机单卡的视角写好的代码，<strong>自动具备多机多卡分布式数据并行的能力。</strong></p>
<h4 id="_4">如何配置并运行分布式训练？<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h4>
<p>还是以上面"快速开始"部分演示的代码为例，在 <code>train.sh</code> 中，只要用 <code>--num_nodes</code> 指定节点（机器）个数，同时用 <code>--node_ips</code> 指定节点的 IP 地址，然后用 <code>--gpu_num_per_node</code> 指定每个节点上使用的卡数，就轻松地完成了分布式的配置。</p>
<p>例如，想要在2机8卡上进行分布式训练，像下面这样配置：</p>
<div class="highlight"><pre><span></span><code># train.sh
python3 of_cnn_train_val.py \
    --num_nodes=2 \
    --node_ips=&quot;192.168.1.1, 192.168.1.2&quot;
    --gpu_num_per_node=4 \
    ...
    --model=&quot;resnet50&quot;
</code></pre></div>
<p>然后分别在两台机器上，同时执行：</p>
<div class="highlight"><pre><span></span><code>./train.sh
</code></pre></div>
<p>程序启动后，通过 <code>watch -n 0.1 nvidia-smi</code> 命令可以看到，两台机器的 GPU 都开始了工作。一段时间后，会在 <code>--node_ips</code> 设置中的第一台机器的屏幕上，打印输出。</p>
<h3 id="_5">混合精度训练与预测<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>目前，OneFlow 已经原生支持 float16/float32 的混合精度训练。训练时，模型参数（权重）使用 float16 进行训练，同时保留 float32 用作梯度更新和计算过程。由于参数的存储减半，会带来训练速度的提升。</p>
<p>在 OneFlow 中开启 float16/float32 的混合精度训练模式，ResNet50 的训练速度理论上能达到<code>1.7</code>倍的加速。</p>
<h4 id="float16-float32">如何开启 float16 / float32 混合精度训练？<a class="headerlink" href="#float16-float32" title="Permanent link">&para;</a></h4>
<p>只需要在 <code>train.sh</code> 脚本中添加参数 <code>--use_fp16=True</code> 即可。</p>
<h4 id="_6">混合精度模型<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h4>
<p>我们为您提供了一个在 ImageNet2012 完整训练了90个 epoch 的混合精度模型，Top_1：77.33%</p>
<p>您可以直接下载使用：<a href="https://oneflow-public.oss-cn-beijing.aliyuncs.com/model_zoo/resnet_fp16_of_best_model_val_top1_77330.zip">resnet50_v15_fp16</a></p>
<h2 id="advanced">进阶 Advanced<a class="headerlink" href="#advanced" title="Permanent link">&para;</a></h2>
<h3 id="_7">参数对齐<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<p>OneFlow 的 ResNet50 实现，为了保证和<a href="https://github.com/NVIDIA/DeepLearningExamples/tree/master/MxNet/Classification/RN50v1.5">英伟达的 Mxnet 版实现</a>对齐，我们从 learning rate 学习率，优化器 Optimizer 的选择，数据增强的图像参数设定，到更细的每一层网络的形态，bias，weight 初始化等都做了细致且几乎完全一致的对齐工作。具体的参数对齐工作，请参考：<a href="https://github.com/Oneflow-Inc/OneFlow-Benchmark/blob/master/Classification/cnns">OneFlow-Benchmark</a> 仓库</p>
<h3 id="_8">数据集制作<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<h4 id="_9">用于图像分类数据集简介<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h4>
<p>用于图像分类的公开数据集有CIFAR，ImageNet 等等，这些数据集中，是以 jpeg 的格式提供原始的图片。</p>
<ul>
<li>
<p><a href="http://www.cs.toronto.edu/~kriz/cifar.html">CIFAR</a>
  是由Hinton 的学生 Alex Krizhevsky 和 Ilya Sutskever 整理的一个用于识别普适物体的小型数据集。包括CIFAR-10和CIFAR-100。</p>
</li>
<li>
<p><a href="http://image-net.org/index">ImageNet</a>
  ImageNet 数据集，一般是指2010-2017年间大规模视觉识别竞赛 (ILSVRC) 的所使用的数据集的统称。ImageNet 数据从2010年来稍有变化，常用 ImageNet-2012 数据集包含1000个类别，其中训练集包含1,281,167张图片，每个类别数据732至1300张不等，验证集包含50,000张图片，平均每个类别50张图片。</p>
</li>
</ul>
<p>完整的 ImageNet(2012)制作过程，请参考 tools 目录下的<a href="https://github.com/Oneflow-Inc/OneFlow-Benchmark/blob/master/Classification/cnns/tools/README.md">README说明</a></p>
<h3 id="oneflow-onnx">OneFlow 模型转 ONNX 模型<a class="headerlink" href="#oneflow-onnx" title="Permanent link">&para;</a></h3>
<h4 id="_10">简介<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h4>
<p><strong>ONNX (Open Neural Network Exchange)</strong>  是一种较为广泛使用的神经网络中间格式，通过 ONNX 格式，OneFlow 模型可以被许多部署框架（如 OpenVINO、ONNX Runtime 和移动端的 ncnn、tnn、TEngine 等）所使用。这一节介绍如何将训练好的 ResNet50 v1.5 模型转换为 ONNX 模型并验证正确性。</p>
<h4 id="_11">快速上手<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h4>
<p>我们提供了完整代码：<a href="https://github.com/Oneflow-Inc/OneFlow-Benchmark/blob/master/Classification/cnns/resnet_to_onnx.py">resnet_to_onnx.py</a>  帮你轻松完成模型的转换和测试的工作</p>
<p><strong>步骤一：</strong> 下载预训练模型：<a href="https://oneflow-public.oss-cn-beijing.aliyuncs.com/model_zoo/resnet_v15_of_best_model_val_top1_77318.tgz">resnet50_v1.5_model</a> ，解压后放入当前目录</p>
<p><strong>步骤二：</strong> 执行：<code>python3 resnet_to_onnx.py</code></p>
<p>此代码将完成 OneFlow 模型 -&gt; ONNX 模型的转化，然后使用 ONNX Runtime 加载转换后的模型对单张图片进行测试。测试图片如下：</p>
<div align="center">
    <img src="imgs/tiger.jpg" align='center'/>
</div>
<blockquote>
<p>​                                             图片来源：<a href="https://en.wikipedia.org/wiki/Tiger">https://en.wikipedia.org/wiki/Tiger</a></p>
</blockquote>
<p>输出：</p>
<div class="highlight"><pre><span></span><code><span class="n">Convert</span> <span class="n">to</span> <span class="n">onnx</span> <span class="n">success</span><span class="err">!</span> <span class="o">&gt;&gt;</span>  <span class="n">onnx</span><span class="o">/</span><span class="n">model</span><span class="o">/</span><span class="n">resnet_v15_of_best_model_val_top1_77318</span><span class="o">.</span><span class="n">onnx</span>
<span class="n">data</span><span class="o">/</span><span class="n">tiger</span><span class="o">.</span><span class="n">jpg</span>
<span class="n">Are</span> <span class="n">the</span> <span class="n">results</span> <span class="n">equal</span><span class="err">?</span> <span class="n">Yes</span>
<span class="n">Class</span><span class="p">:</span> <span class="n">tiger</span><span class="p">,</span> <span class="n">Panthera</span> <span class="n">tigris</span><span class="p">;</span> <span class="n">score</span><span class="p">:</span> <span class="mf">0.8112028241157532</span>
</code></pre></div>
<h4 id="onnx">如何生成 ONNX 模型<a class="headerlink" href="#onnx" title="Permanent link">&para;</a></h4>
<p>上面的示例代码，介绍了如何转换 OneFlow 的 ResNet 模型至 ONNX 模型，并给出了一个利用 onnx runtime 进行预测的例子，同样，你也可以利用下面的步骤来完成自己训练的 ResNet 或其他模型的转换。</p>
<p><strong>步骤一：将模型权重保存到本地</strong></p>
<p>首先指定待转换的 OneFlow 模型路径，然后指定转换后的 ONNX 模型存放路径，例如示例中：</p>
<div class="highlight"><pre><span></span><code><span class="c1">#set up your model path</span>
<span class="n">flow_weights_path</span> <span class="o">=</span> <span class="s1">&#39;resnet_v15_of_best_model_val_top1_77318&#39;</span>
<span class="n">onnx_model_dir</span> <span class="o">=</span> <span class="s1">&#39;onnx/model&#39;</span>
</code></pre></div>
<p><strong>步骤二：新建一个用于推理的 job function</strong></p>
<p>然后新建一个用于推理的 job function，它只包含网络结构本身，不包含读取 OFRecord 的算子，并且直接接受 numpy 数组形式的输入。可参考 <code>resnet\_to\_onnx.py</code> 中的 <code>InferenceNet</code>。</p>
<p><strong>步骤三：调用 <code>flow.onnx.export</code>方法</strong></p>
<p>接下来代码中会调用 <code>oneflow_to_onnx()</code> 方法，此方法包含了核心的模型转换方法： <code>flow.onnx.export()</code></p>
<p><strong><code>flow.onnx.export</code></strong> 将从 OneFlow 网络得到 ONNX 模型，它的第一个参数是上文所说的专用于推理的 job function，第二个参数是 OneFlow 模型路径，第三个参数是（转换后）ONNX 模型的存放路径</p>
<div class="highlight"><pre><span></span><code><span class="n">onnx_model</span> <span class="o">=</span> <span class="n">oneflow_to_onnx</span><span class="p">(</span><span class="n">InferenceNet</span><span class="p">,</span> <span class="n">flow_weights_path</span><span class="p">,</span> <span class="n">onnx_model_dir</span><span class="p">,</span> <span class="n">external_data</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
<h4 id="onnx_1">验证 ONNX 模型的正确性<a class="headerlink" href="#onnx_1" title="Permanent link">&para;</a></h4>
<p>生成 ONNX 模型之后可以使用 ONNX Runtime 运行 ONNX 模型，以验证 OneFlow 模型和 ONNX 模型能够在相同的输入下产生相同的结果。相应的代码在 resnet_to_onnx.py 的 <code>check_equality</code>。</p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../extended_topics/oneflow_convert_tools.html" class="md-footer__link md-footer__link--prev" aria-label="上一页: OneFlow 和 ONNX 交互" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                上一页
              </span>
              OneFlow 和 ONNX 交互
            </div>
          </div>
        </a>
      
      
        
        <a href="yolov3.html" class="md-footer__link md-footer__link--next" aria-label="下一页: YoloV3" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                下一页
              </span>
              YoloV3
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2017 - 2021 OneFlow
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs"], "translations": {"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.477d984a.min.js", "version": {"provider": "mike"}}</script>
    
    
      <script src="../assets/javascripts/bundle.ddd52ceb.min.js"></script>
      
    
  </body>
</html>