
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="OneFlow: a efficient distributed deep learning framework.">
      
      
      
      
        <link rel="canonical" href="https://docs.oneflow.org/v0.4.0/adv_examples/bert.html">
      
      <link rel="icon" href="../assets/favicon.png">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-7.1.11">
    
    
      
        <title>Bert - OneFlow</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.3754935a.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.f1a3b89f.min.css">
        
          
          
          <meta name="theme-color" content="#4051b5">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#summary" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../index.html" title="OneFlow" class="md-header__button md-logo" aria-label="OneFlow" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 89 89">
  <path d="M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z" />
  <path d="M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z" style="fill-opacity: 0.5" />
  <path d="M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z" />
  <path d="M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z" style="fill-opacity: 0.25" />
</svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            OneFlow
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Bert
            
          </span>
        </div>
      </div>
    </div>
    
    
      <div class="md-header__option">
        <div class="md-select">
          
          <button class="md-header__button md-icon" aria-label="Select language">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.52 17.52 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04M18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12m-2.62 7 1.62-4.33L19.12 17h-3.24z"/></svg>
          </button>
          <div class="md-select__inner">
            <ul class="md-select__list">
              
                <li class="md-select__item">
                  <a href="https://docs.oneflow.org/en" hreflang="en" class="md-select__link">
                    English
                  </a>
                </li>
                
                <li class="md-select__item">
                  <a href="https://docs.oneflow.org" hreflang="zh" class="md-select__link">
                    中文
                  </a>
                </li>
                
            </ul>
          </div>
        </div>
      </div>
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://www.github.com/oneflow-Inc/oneflow" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    OneFlow
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../index.html" class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../quick_start/install.html" class="md-tabs__link">
        Quick Start
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../basics_topics/data_input.html" class="md-tabs__link">
        Basic Topics
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../extended_topics/job_function_define_call.html" class="md-tabs__link">
        Extended Topics
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="https://oneflow.readthedocs.io/en/master/" class="md-tabs__link">
        API
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../contribute/intro.html" class="md-tabs__link">
        Contribute
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="OneFlow" class="md-nav__button md-logo" aria-label="OneFlow" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 89 89">
  <path d="M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z" />
  <path d="M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z" style="fill-opacity: 0.5" />
  <path d="M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z" />
  <path d="M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z" style="fill-opacity: 0.25" />
</svg>

    </a>
    OneFlow
  </label>
  
    <div class="md-nav__source">
      
<a href="https://www.github.com/oneflow-Inc/oneflow" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    OneFlow
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      <label class="md-nav__link" for="__nav_2">
        Quick Start
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Quick Start" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Quick Start
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../quick_start/install.html" class="md-nav__link">
        Installation
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../quick_start/quickstart_in_3_min.html" class="md-nav__link">
        Quick Start in 3 Minutes
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../quick_start/lenet_mnist.html" class="md-nav__link">
        Recognition of MNIST Handwritten Digits
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      <label class="md-nav__link" for="__nav_3">
        Basic Topics
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Basic Topics" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Basic Topics
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../basics_topics/data_input.html" class="md-nav__link">
        Data Input
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../basics_topics/build_nn_with_op_and_layer.html" class="md-nav__link">
        Build a Neural Network
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../basics_topics/optimizer_in_function_config.html" class="md-nav__link">
        Optimization Algorithm and Parameter Configuration
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../basics_topics/async_get.html" class="md-nav__link">
        Get results from job function
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../basics_topics/model_load_save.html" class="md-nav__link">
        Loading and saving of model
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../basics_topics/distributed_train.html" class="md-nav__link">
        Distributed training
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../basics_topics/concept_explanation.html" class="md-nav__link">
        Term & Concept Explanation
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../basics_topics/essentials_of_oneflow.html" class="md-nav__link">
        OneFlow System Design
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      <label class="md-nav__link" for="__nav_4">
        Extended Topics
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Extended Topics" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Extended Topics
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../extended_topics/job_function_define_call.html" class="md-nav__link">
        The Definition and Call of Job Function
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../extended_topics/consistent_mirrored.html" class="md-nav__link">
        Consistent & Mirrored View
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../extended_topics/model_mixed_parallel.html" class="md-nav__link">
        Features of Parallelism in OneFlow
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../extended_topics/ofrecord.html" class="md-nav__link">
        The OFRecord Data Format
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../extended_topics/how_to_make_ofdataset.html" class="md-nav__link">
        Loading and Preparing OFRecord Dataset
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../extended_topics/how_to_convert_image_to_ofrecord.html" class="md-nav__link">
        Convert Image Files to OFRecord Datasets
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../extended_topics/watch_watch_diff.html" class="md-nav__link">
        Obtain Runtime Data
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../extended_topics/debug_by_vscode.html" class="md-nav__link">
        Use VS Code to Debug OneFlow
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../extended_topics/user_op.html" class="md-nav__link">
        User Defined OP
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../extended_topics/oneflow_convert_tools.html" class="md-nav__link">
        OneFlow And ONNX Convert
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      <label class="md-nav__link" for="__nav_5">
        API
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="API" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          API
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="https://oneflow.readthedocs.io/en/master/" class="md-nav__link">
        API
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      <label class="md-nav__link" for="__nav_6">
        Contribute
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Contribute" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Contribute
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../contribute/intro.html" class="md-nav__link">
        Contribute to OneFlow
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    Summary
  </a>
  
    <nav class="md-nav" aria-label="Summary">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#model" class="md-nav__link">
    Model
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#quickstart" class="md-nav__link">
    Quickstart
  </a>
  
    <nav class="md-nav" aria-label="Quickstart">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get-dataset" class="md-nav__link">
    Get dataset
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bert-pretrained" class="md-nav__link">
    BERT pretrained
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#detailed-description" class="md-nav__link">
    Detailed description
  </a>
  
    <nav class="md-nav" aria-label="Detailed description">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scripts" class="md-nav__link">
    Scripts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#options" class="md-nav__link">
    Options
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-wikipedia-bookcorpus-dataset" class="md-nav__link">
    Use Wikipedia + BookCorpus dataset
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#oneflow-bert-model-converted-from-tensorflow-model" class="md-nav__link">
    OneFlow BERT model converted from Tensorflow Model
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#finetune-task-squad" class="md-nav__link">
    Finetune task: SQuAD
  </a>
  
    <nav class="md-nav" aria-label="Finetune task: SQuAD">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#extend-to-squad-model" class="md-nav__link">
    Extend to SQuAD model
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#merge-pretrained-model-into-squad" class="md-nav__link">
    Merge pretrained model into SQuAD
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#problem-on-training-times" class="md-nav__link">
    Problem on training times
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#start-squad-training" class="md-nav__link">
    Start SQuAD training
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prediction-and-evaluatoin" class="md-nav__link">
    Prediction and evaluatoin
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#distributed-training" class="md-nav__link">
    Distributed training
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/OneFlow-Inc/oneflow-documentation/blob/master/en/docs/adv_examples/bert.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  <h1>Bert</h1>
                
                <h2 id="summary">Summary<a class="headerlink" href="#summary" title="Permanent link">&para;</a></h2>
<p>BERT(Bidirectional Encoder Representations from Transformers) is a technique for NLP. In our case, we implement BERT based on the paper <a href="https://arxiv.org/abs/1810.04805">BERT: Pre-training of Deep Bidirectional Transformers for Language Understanding</a> using OneFlow.</p>
<h3 id="model">Model<a class="headerlink" href="#model" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th align="center"><strong>Model</strong></th>
<th align="center"><strong>Hidden layers</strong></th>
<th align="center"><strong>Hidden unit size</strong></th>
<th align="center"><strong>Attention heads</strong></th>
<th align="center"><strong>Feedforward filter size</strong></th>
<th align="center"><strong>Max sequence length</strong></th>
<th align="center"><strong>Parameters</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">BERTBASE</td>
<td align="center">12 encoder</td>
<td align="center">768</td>
<td align="center">12</td>
<td align="center">4 x  768</td>
<td align="center">512</td>
<td align="center">110M</td>
</tr>
</tbody>
</table>
<p>There are commonly two steps in BERT:</p>
<ul>
<li>
<p>First, BERT pretrained model is obtained by pre-training;</p>
</li>
<li>
<p>Then, on the basis of the obtained pretrained model, an additional layer of network is added and finetuned to get the downstream application.</p>
</li>
</ul>
<h2 id="quickstart">Quickstart<a class="headerlink" href="#quickstart" title="Permanent link">&para;</a></h2>
<h3 id="get-dataset">Get dataset<a class="headerlink" href="#get-dataset" title="Permanent link">&para;</a></h3>
<p>We provide <a href="https://oneflow-static.oss-cn-beijing.aliyuncs.com/oneflow-tutorial-attachments/bert_squad_dataset.zip">OFRecord dataset and relevant other files</a>, you can get and unzip it by running commands below:</p>
<p><div class="highlight"><pre><span></span><code>wget https://oneflow-static.oss-cn-beijing.aliyuncs.com/oneflow-tutorial-attachments/bert_squad_dataset.zip
unzip bert_squad_dataset.zip
</code></pre></div>
The list of files is as follows:</p>
<ul>
<li>
<p>bert_config.json、vocab.txt：Files needed to generate "prediction json" file from <a href="https://github.com/google-research/bert">google bert</a></p>
</li>
<li>
<p>dev-v1.1/, dev-v1.1.json：SQuAD test set for evaluation</p>
</li>
<li>
<p>part-0：pre-trained training set contains 40 samples</p>
</li>
<li>
<p>train-v1.1：SQuAD training set that has been coverted to OFRecords</p>
</li>
</ul>
<p>The above files will be used in the following pretraining tasks and squad finetune.</p>
<h3 id="bert-pretrained">BERT pretrained<a class="headerlink" href="#bert-pretrained" title="Permanent link">&para;</a></h3>
<p>Firstly, clone the <code>OneFlow-Benchmark</code>:</p>
<div class="highlight"><pre><span></span><code>git clone https://github.com/Oneflow-Inc/OneFlow-Benchmark.git
<span class="nb">cd</span> OneFlow-Benchmark/LanguageModeling/BERT/
</code></pre></div>
<p>Then, with the following command, we can use our pretraining model and small sample set to start the BERT pre-training.
<div class="highlight"><pre><span></span><code>python ./run_pretraining.py<span class="se">\</span>
    --gpu_num_per_node<span class="o">=</span><span class="m">1</span> <span class="se">\</span>
    --learning_rate<span class="o">=</span>3e-5 <span class="se">\</span>
    --batch_size_per_device<span class="o">=</span><span class="m">1</span> <span class="se">\</span>
    --iter_num<span class="o">=</span><span class="m">3</span> <span class="se">\</span>
    --loss_print_every_n_iter<span class="o">=</span><span class="m">50</span> <span class="se">\</span>
    --seq_length<span class="o">=</span><span class="m">128</span> <span class="se">\</span>
    --max_predictions_per_seq<span class="o">=</span><span class="m">20</span> <span class="se">\</span>
    --num_hidden_layers<span class="o">=</span><span class="m">12</span> <span class="se">\</span>
    --num_attention_heads<span class="o">=</span><span class="m">12</span> <span class="se">\</span>
    --max_position_embeddings<span class="o">=</span><span class="m">512</span> <span class="se">\</span>
    --type_vocab_size<span class="o">=</span><span class="m">2</span> <span class="se">\</span>
    --vocab_size<span class="o">=</span><span class="m">30522</span> <span class="se">\</span>
    --attention_probs_dropout_prob<span class="o">=</span><span class="m">0</span>.0 <span class="se">\</span>
    --hidden_dropout_prob<span class="o">=</span><span class="m">0</span>.0 <span class="se">\</span>
    --hidden_size_per_head<span class="o">=</span><span class="m">64</span> <span class="se">\</span>
    --use_boxing_v2<span class="o">=</span>True <span class="se">\</span>
    --data_dir<span class="o">=</span>./dataset/ <span class="se">\</span>
    --data_part_num<span class="o">=</span><span class="m">1</span> <span class="se">\</span>
    --log_dir<span class="o">=</span>./bert_regresssioin_test/of <span class="se">\</span>
    --loss_print_every_n_iter<span class="o">=</span><span class="m">5</span> <span class="se">\</span>
    --model_save_dir<span class="o">=</span>./bert_regresssioin_test/of <span class="se">\</span>
    --warmup_batches <span class="m">831</span> <span class="se">\</span>
    --save_last_snapshot True
</code></pre></div></p>
<p>We will see the output similar to the following:
<div class="highlight"><pre><span></span><code>==================================================================
Running bert: num_gpu_per_node = 1, num_nodes = 1. ==================================================================
gpu_num_per_node = 1
node_num = 1
node_list = None
learning_rate = 3e-05
weight_decay_rate = 0.01
batch_size_per_device = 1
iter_num = 20
warmup_batches = 831
log_every_n_iter = 1
data_dir = ./dataset/
data_part_num = 1
use_fp16 = None
use_boxing_v2 = True
loss_print_every_n_iter = 5
model_save_every_n_iter = 10000
model_save_dir = ./bert_regresssioin_test/of
save_last_snapshot = True
model_load_dir = None
log_dir = ./bert_regresssioin_test/of
seq_length = 128
max_predictions_per_seq = 20
num_hidden_layers = 12
num_attention_heads = 12
max_position_embeddings = 512
type_vocab_size = 2
vocab_size = 30522
attention_probs_dropout_prob = 0.0
hidden_dropout_prob = 0.0
hidden_size_per_head = 64
------------------------------------------------------------------
Time stamp: 2020-07-06-19:09:29
I0706 19:09:29.605840639   34801 ev_epoll_linux.c:82]        Use of signals is disabled. Epoll engine will not be used
Init model on demand
iter 4, total_loss: 11.032, mlm_loss: 10.281, nsp_loss: 0.751, speed: 33.086(sec/batch), 0.151(sentences/sec)
iter 9, total_loss: 11.548, mlm_loss: 10.584, nsp_loss: 0.965, speed: 0.861(sec/batch), 5.806(sentences/sec)
iter 14, total_loss: 10.697, mlm_loss: 10.249, nsp_loss: 0.448, speed: 0.915(sec/batch), 5.463(sentences/sec)
iter 19, total_loss: 10.685, mlm_loss: 10.266, nsp_loss: 0.419, speed: 1.087(sec/batch), 4.602(sentences/sec)
Saving model to ./bert_regresssioin_test/of/last_snapshot. ------------------------------------------------------------------
average speed: 0.556(sentences/sec)
------------------------------------------------------------------
</code></pre></div></p>
<h2 id="detailed-description">Detailed description<a class="headerlink" href="#detailed-description" title="Permanent link">&para;</a></h2>
<h3 id="scripts">Scripts<a class="headerlink" href="#scripts" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th align="center"><strong>Files</strong></th>
<th align="center"><strong>Description</strong></th>
<th align="center"><strong>Belongs to</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">pretrain.py、bert.py</td>
<td align="center">Define the BERT model</td>
<td align="center">BERT</td>
</tr>
<tr>
<td align="center">run_pretraining.py</td>
<td align="center">Start BERT training. The user can configure the training environment and parameters of the BERT training through the command line parameters. The specific meanings of each option will be described in the <strong>script options</strong> below.</td>
<td align="center">BERT</td>
</tr>
<tr>
<td align="center">squad.py</td>
<td align="center">define SQuAD network</td>
<td align="center">SQuAD</td>
</tr>
<tr>
<td align="center">run_squad.py</td>
<td align="center">Run the SQuAD training</td>
<td align="center">SQuAD</td>
</tr>
<tr>
<td align="center">run_squad_predict.py</td>
<td align="center">Run the trained SQuAD model to predict.</td>
<td align="center">SQuAD</td>
</tr>
<tr>
<td align="center">npy2json.py</td>
<td align="center">Script required to overt OneFlow's prediction results to json.</td>
<td align="center">SQuAD</td>
</tr>
<tr>
<td align="center">convert_tf_ckpt_to_of.py</td>
<td align="center">Convert model from TensorFlow to OneFlow</td>
<td align="center">BERT/SQuAD</td>
</tr>
</tbody>
</table>
<h3 id="options">Options<a class="headerlink" href="#options" title="Permanent link">&para;</a></h3>
<p>The script <code>run_pretraining.py</code> runs the pretraining and configured by command line options. You can run <code>run_pretraining.py --help</code> to see the options. The following is a detailed description of each option：</p>
<ul>
<li>
<p>gpu_num_per_node: count of devices on each node which must be consistent on each machine</p>
</li>
<li>
<p>node_num: count of nodes, that is, the count of hosts in distributed system</p>
</li>
<li>
<p>node_list: list of nodes. When thec count of nodes is more than one, we should spcifiy list of nodes by node_list. It's a string seperated by commans like <code>--node_num=2 --node_list="192.168.1.12,192.168.1.14"</code></p>
</li>
<li>
<p>learning_rate: learning rate</p>
</li>
<li>
<p>weight_decay_rate: decay rate of weight</p>
</li>
<li>
<p>batch_size_per_device: batch size on each device</p>
</li>
<li>
<p>iter_num ITER_NUM: count of iterations</p>
</li>
<li>
<p>warmup_batches: batches of warmup, default to 10000</p>
</li>
<li>
<p>data_dir: path to OFRecord dataset</p>
</li>
<li>
<p>data_part_num: number of files in the folder of OFRecord dataset</p>
</li>
<li>
<p>use_fp16: use float16 or not</p>
</li>
<li>
<p>use_boxing_v2: use boxing v2 or not</p>
</li>
<li>
<p>loss_print_every_n_iter: print loss every n iterations</p>
</li>
<li>
<p>model_save_every_n_iter: save the model every n iterations</p>
</li>
<li>
<p>model_save_dir: path to save the model</p>
</li>
<li>
<p>save_last_snapshot: whether save the model when training is finished</p>
</li>
<li>
<p>model_load_dir: path to load the model</p>
</li>
<li>
<p>log_dir LOG_DIR: specify the path of log</p>
</li>
<li>
<p>seq_length: length of sequence, default to 512</p>
</li>
<li>
<p>max_predictions_per_seq: default to 80</p>
</li>
<li>
<p>num_hidden_layers: number of hidden layers, defaul to 24</p>
</li>
<li>
<p>num_attention_heads: number of attentoion heads，default to 16</p>
</li>
</ul>
<h3 id="use-wikipedia-bookcorpus-dataset">Use Wikipedia + BookCorpus dataset<a class="headerlink" href="#use-wikipedia-bookcorpus-dataset" title="Permanent link">&para;</a></h3>
<p>If it is necessary to carry out the pretraining of BERT from scratch, a large dataset should be used.</p>
<p>If necessary, we can download TFRecord dataset from <a href="https://github.com/google-research/bert">google-research BERT</a> and then make OFRecord dataset from it by methods in the article <a href="../extended_topics/how_to_make_ofdataset.html">Loading and preparing OFRecord dataset</a>.</p>
<h3 id="oneflow-bert-model-converted-from-tensorflow-model">OneFlow BERT model converted from Tensorflow Model<a class="headerlink" href="#oneflow-bert-model-converted-from-tensorflow-model" title="Permanent link">&para;</a></h3>
<p>If you want to directly use the pretrained model for finetune tasks (such as the SQuAD shown below), you can consider downloading directly it from <a href="https://github.com/google-research/bert">google-research BERT</a> and then use the script <code>convert_tf_ckpt_to_of.py</code> we provided to convert it to OneFlow model.</p>
<p>The conversion process is as follows:</p>
<p>Firstly, download and unzip a BERT pretrained model of specified version, eg: <code>uncased_L-12_H-768_A-12</code>.
<div class="highlight"><pre><span></span><code>wget https://storage.googleapis.com/bert_models/2020_02_20/uncased_L-12_H-768_A-12.zip
unzip uncased_L-12_H-768_A-12.zip -d uncased_L-12_H-768_A-12
</code></pre></div></p>
<p>And then, run commands below:
<div class="highlight"><pre><span></span><code>cd uncased_L-12_H-768_A-12/
cat &gt; checkpoint &lt;&lt;ONEFLOW
model_checkpoint_path: &quot;bert_model.ckpt&quot;
all_model_checkpoint_paths: &quot;bert_model.ckpt&quot;
ONEFLOW
</code></pre></div></p>
<p>It will create a file named <code>checkpoint</code> in the directory and write content below into it:
<div class="highlight"><pre><span></span><code>model_checkpoint_path: &quot;bert_model.ckpt&quot;
all_model_checkpoint_paths: &quot;bert_model.ckpt&quot;
</code></pre></div></p>
<p>Now that the TensorFlow model directory to be converted is ready, the hierarchy is:
<div class="highlight"><pre><span></span><code>uncased_L-12_H-768_A-12
├── bert_config.json
├── bert_model.ckpt.data-00000-of-00001
├── bert_model.ckpt.index
├── checkpoint
└── vocab.txt
</code></pre></div></p>
<p>And then we use <code>convert_tf_ckpt_to_of.py</code> to convert model to OneFlow format:
<div class="highlight"><pre><span></span><code>python convert_tf_ckpt_to_of.py <span class="se">\</span>
  --tf_checkpoint_path ./uncased_L-12_H-768_A-12 <span class="se">\</span>
  --of_dump_path ./uncased_L-12_H-768_A-12-oneflow
</code></pre></div>
The above command saves the converted OneFlow format model in <code>./uncased_L-12_H-768_A-12-oneflow</code> directory for later use(eg: SQuAD).</p>
<h2 id="finetune-task-squad">Finetune task: SQuAD<a class="headerlink" href="#finetune-task-squad" title="Permanent link">&para;</a></h2>
<h3 id="extend-to-squad-model">Extend to SQuAD model<a class="headerlink" href="#extend-to-squad-model" title="Permanent link">&para;</a></h3>
<p>We only need to add a layer of <code>output</code> on the basis of BERT's backbone and modify the expression of loss. We can see the whole code in <code>squad.py</code>, and there are key modifications:
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">SQuADTrain</span><span class="p">():</span>
    <span class="c1">#... backbone = bert_util.BertBackbone()</span>

    <span class="c1">#add a fully-connected layer base on BERT</span>
    <span class="k">with</span> <span class="n">flow</span><span class="o">.</span><span class="n">name_scope</span><span class="p">(</span><span class="s2">&quot;cls-squad&quot;</span><span class="p">):</span>
        <span class="n">final_hidden</span> <span class="o">=</span> <span class="n">backbone</span><span class="o">.</span><span class="n">sequence_output</span><span class="p">()</span>
        <span class="n">final_hidden_matrix</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">final_hidden</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">])</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">bert_util</span><span class="o">.</span><span class="n">_FullyConnected</span><span class="p">(</span>
                    <span class="n">final_hidden_matrix</span><span class="p">,</span>
                    <span class="n">hidden_size</span><span class="p">,</span>
                    <span class="n">units</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">weight_initializer</span><span class="o">=</span><span class="n">bert_util</span><span class="o">.</span><span class="n">CreateInitializer</span><span class="p">(</span><span class="n">initializer_range</span><span class="p">),</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">)</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">seq_length</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

        <span class="n">start_logits</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">end_logits</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="c1">#redefine the loss of SQuAD</span>
        <span class="n">start_loss</span> <span class="o">=</span> <span class="n">_ComputeLoss</span><span class="p">(</span><span class="n">start_logits</span><span class="p">,</span> <span class="n">start_positions_blob</span><span class="p">,</span> <span class="n">seq_length</span><span class="p">)</span>
        <span class="n">end_loss</span> <span class="o">=</span> <span class="n">_ComputeLoss</span><span class="p">(</span><span class="n">end_logits</span><span class="p">,</span> <span class="n">end_positions_blob</span><span class="p">,</span> <span class="n">seq_length</span><span class="p">)</span>

        <span class="n">total_loss</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">start_loss</span> <span class="o">+</span> <span class="n">end_loss</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">total_loss</span>
</code></pre></div></p>
<p>We run the script below to start SQuAD training to get and save a initialized model.</p>
<p><div class="highlight"><pre><span></span><code>python ./run_squad.py\
    --gpu_num_per_node=1\
    --learning_rate=3e-5\
    --batch_size_per_device=2\
    --iter_num=50\
    --loss_print_every_n_iter=50\
    --seq_length=384\
    --max_predictions_per_seq=20\
    --num_hidden_layers=12\
    --num_attention_heads=12\
    --max_position_embeddings=512\
    --type_vocab_size=2\
    --vocab_size=30522\
    --attention_probs_dropout_prob=0.0\
    --hidden_dropout_prob=0.0\
    --hidden_size_per_head=64\
    --use_boxing_v2=True\
    --data_dir=./dataset/train-v1.1\
    --data_part_num=1\
    --log_dir=./bert_regresssioin_test/of\
    --model_save_dir=./bert_regresssioin_test/of\
    --warmup_batches 831\
    --save_last_snapshot True
</code></pre></div>
There will be a initialized model in the path <code>./bert_regresssioin_test/of/last_snapshot</code>. We will merge it with pretrained BERT model and fintune it.</p>
<h3 id="merge-pretrained-model-into-squad">Merge pretrained model into SQuAD<a class="headerlink" href="#merge-pretrained-model-into-squad" title="Permanent link">&para;</a></h3>
<p>SQuAD is extended from pretrained model of BERT. We should merge the pretrained model into SQuAD according to the method introduced in this article<a href="../basics_topics/model_load_save.html">Loading and saving of model</a>.</p>
<div class="highlight"><pre><span></span><code>cp -R ./bert_regresssioin_test/of/last_snapshot ./squadModel
cp -R --remove-destination ./dataset/uncased_L-12_H-768_A-12_oneflow/* ./squadModel/
</code></pre></div>
<h3 id="problem-on-training-times">Problem on training times<a class="headerlink" href="#problem-on-training-times" title="Permanent link">&para;</a></h3>
<p>There is a folder named <code>System-Train-TrainStep-xxx</code> in the path of pretrained model folder and the file named "out" contains the count if iterations. The <code>leraning rate</code> changes dynamically with the count of iterations.</p>
<p>In order to prevent training of finetuning from the saved iteration affecting, the binary data in the out file should be cleared to zero.
<div class="highlight"><pre><span></span><code>cd System-Train-TrainStep-xxx
xxd -r &gt; out &lt;&lt;ONEFLOW
00000000: 0000 0000 0000 0000
ONEFLOW
</code></pre></div></p>
<p>If you are using a pretrained model transferred from TensorFlow, you can skip this step.</p>
<h3 id="start-squad-training">Start SQuAD training<a class="headerlink" href="#start-squad-training" title="Permanent link">&para;</a></h3>
<p>Start SQuAD training by running the script <code>run_suqad.py</code> with configuration below:</p>
<ul>
<li>
<p>use SQuAD model <code>./squadModel</code></p>
</li>
<li>
<p>use SQuAD v1.1 as training set</p>
</li>
<li>
<p>epoch = 3 (<code>iternum = 88641*3/(4*8) = 8310</code>)</p>
</li>
<li>
<p>learning rate = 3e-5</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code>python ./run_squad.py\
    --gpu_num_per_node=4\
    --learning_rate=3e-5\
    --batch_size_per_device=8\
    --iter_num=8310\
    --loss_print_every_n_iter=50\
    --seq_length=384\
    --max_predictions_per_seq=20\
    --num_hidden_layers=12\
    --num_attention_heads=12\
    --max_position_embeddings=512\
    --type_vocab_size=2\
    --vocab_size=30522\
    --attention_probs_dropout_prob=0.0\
    --hidden_dropout_prob=0.0\
    --hidden_size_per_head=64\
    --use_boxing_v2=True\
    --data_dir=./dataset/train-v1.1\
    --data_part_num=8\
    --log_dir=./bert_regresssioin_test/of\
    --model_save_dir=./bert_regresssioin_test/of\
    --warmup_batches 831\
    --save_last_snapshot True\
    --model_load_dir=./squadModel
</code></pre></div>
<h3 id="prediction-and-evaluatoin">Prediction and evaluatoin<a class="headerlink" href="#prediction-and-evaluatoin" title="Permanent link">&para;</a></h3>
<p>In order to generate <a href="https://rajpurkar.github.io/SQuAD-explorer/">Preidiction File</a>, we should generate npy file fist. And then we use <code>write_predictions</code> function in <a href="https://github.com/google-research/bert/blob/master/run_squad.py">google BERT's run_squad.py</a> to convert it to json format.</p>
<p>Run the script <code>run_squad_predict.py</code> to generate <code>all_results.npy</code>:
<div class="highlight"><pre><span></span><code>python run_squad_predict.py <span class="se">\</span>
  --gpu_num_per_node<span class="o">=</span><span class="m">1</span> <span class="se">\</span>
  --batch_size_per_device<span class="o">=</span><span class="m">4</span> <span class="se">\</span>
  --iter_num<span class="o">=</span><span class="m">2709</span> <span class="se">\</span>
  --seq_length<span class="o">=</span><span class="m">384</span> <span class="se">\</span>
  --max_predictions_per_seq<span class="o">=</span><span class="m">20</span> <span class="se">\</span>
  --num_hidden_layers<span class="o">=</span><span class="m">12</span> <span class="se">\</span>
  --num_attention_heads<span class="o">=</span><span class="m">12</span> <span class="se">\</span>
  --max_position_embeddings<span class="o">=</span><span class="m">512</span> <span class="se">\</span>
  --type_vocab_size<span class="o">=</span><span class="m">2</span> <span class="se">\</span>
  --vocab_size<span class="o">=</span><span class="m">30522</span> <span class="se">\</span>
  --attention_probs_dropout_prob<span class="o">=</span><span class="m">0</span>.0 <span class="se">\</span>
  --hidden_dropout_prob<span class="o">=</span><span class="m">0</span>.0 <span class="se">\</span>
  --hidden_size_per_head<span class="o">=</span><span class="m">64</span> <span class="se">\</span>
  --use_boxing_v2<span class="o">=</span>True <span class="se">\</span>
  --data_part_num<span class="o">=</span><span class="m">1</span> <span class="se">\</span>
  --data_dir<span class="o">=</span>./dataset/dev-v1.1 <span class="se">\</span>
  --log_dir<span class="o">=</span>./bert_regresssioin_test/of <span class="se">\</span>
  --model_load_dir<span class="o">=</span>path/to/squadModel <span class="se">\</span>
  --warmup_batches <span class="m">831</span>
</code></pre></div>
Attention: the <code>model_load_dir</code> should be the trained model of SQuAD.</p>
<p>After we get the <code>all_results.npy</code>file, run the script <code>npy2json.py</code> in the repository of <a href="https://github.com/google-research/bert/">google bert</a>(the version of TensorFlow should be v1). The <code>npy2json.py</code> we provide is modified from google bert's <code>run_squad.py</code>:
<div class="highlight"><pre><span></span><code>python npy2json.py\
  --vocab_file=./dataset/vocab.txt \
  --bert_config_file=./dataset/bert_config.json \
  --do_train=False \
  --do_predict=True \
  --all_results_file=./all_results.npy \
  --predict_file=./dataset/dev-v1.1.json \
  --max_seq_length=384 \
  --doc_stride=128 \
  --output_dir=./squad_base/
</code></pre></div></p>
<p>Remember to set the <code>all_results_file</code> to the path of <code>all_results.npy</code> we obtained in the last step.</p>
<p>We will get <code>predictions.json</code> after that which can be evaluated by<a href="https://rajpurkar.github.io/SQuAD-explorer/">evaluate-v1.1.py</a>.</p>
<div class="highlight"><pre><span></span><code>python evaluate-v1.1.py <span class="se">\</span>
./dataset/dev-v1.1.json <span class="se">\</span>
path/to/squad_base/predictions.json
</code></pre></div>
<h2 id="distributed-training">Distributed training<a class="headerlink" href="#distributed-training" title="Permanent link">&para;</a></h2>
<p>As described when we introduce the command line options, we can start distributed training easily by adding the options <code>node_num</code> and <code>node_list</code>:</p>
<div class="highlight"><pre><span></span><code>python run_squad_predict.py <span class="se">\</span>
  --gpu_num_per_node<span class="o">=</span><span class="m">1</span> <span class="se">\</span>
  --batch_size_per_device<span class="o">=</span><span class="m">4</span> <span class="se">\</span>
  --iter_num<span class="o">=</span><span class="m">2709</span> <span class="se">\</span>
  --seq_length<span class="o">=</span><span class="m">384</span> <span class="se">\</span>
  --max_predictions_per_seq<span class="o">=</span><span class="m">20</span> <span class="se">\</span>
  --num_hidden_layers<span class="o">=</span><span class="m">12</span> <span class="se">\</span>
  --num_attention_heads<span class="o">=</span><span class="m">12</span> <span class="se">\</span>
  --max_position_embeddings<span class="o">=</span><span class="m">512</span> <span class="se">\</span>
  --type_vocab_size<span class="o">=</span><span class="m">2</span> <span class="se">\</span>
  --vocab_size<span class="o">=</span><span class="m">30522</span> <span class="se">\</span>
  --attention_probs_dropout_prob<span class="o">=</span><span class="m">0</span>.0 <span class="se">\</span>
  --hidden_dropout_prob<span class="o">=</span><span class="m">0</span>.0 <span class="se">\</span>
  --hidden_size_per_head<span class="o">=</span><span class="m">64</span> <span class="se">\</span>
  --use_boxing_v2<span class="o">=</span>True <span class="se">\</span>
  --data_part_num<span class="o">=</span><span class="m">1</span> <span class="se">\</span>
  --data_dir<span class="o">=</span>./dataset/dev-v1.1 <span class="se">\</span>
  --log_dir<span class="o">=</span>./bert_regresssioin_test/of <span class="se">\</span>
  --model_load_dir<span class="o">=</span>path/to/squadModel <span class="se">\</span>
  --warmup_batches <span class="m">831</span> <span class="se">\</span>
  --node_num<span class="o">=</span><span class="m">2</span> <span class="se">\</span>
  --node_list<span class="o">=</span><span class="s2">&quot;192.168.1.12,192.168.1.14&quot;</span>
</code></pre></div>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2017 - 2021 OneFlow
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.477d984a.min.js", "version": {"provider": "mike"}}</script>
    
    
      <script src="../assets/javascripts/bundle.ddd52ceb.min.js"></script>
      
    
  </body>
</html>